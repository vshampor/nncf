:py:mod:`nncf`
==============

.. py:module:: nncf

.. autoapi-nested-parse::

   Neural Network Compression Framework (NNCF) for enhanced OpenVINOâ„¢ inference.



Subpackages
-----------
.. toctree::
   :titlesonly:
   :maxdepth: 3

   api/index.rst
   common/index.rst
   config/index.rst
   quantization/index.rst
   tensorflow/index.rst
   torch/index.rst



Classes
~~~~~~~

.. autoapisummary::

   nncf.NNCFConfig
   nncf.Dataset
   nncf.CompressWeightsMode
   nncf.DropType
   nncf.ModelType
   nncf.QuantizationMode
   nncf.TargetDevice
   nncf.QuantizationPreset
   nncf.IgnoredScope



Functions
~~~~~~~~~

.. autoapisummary::

   nncf.strip
   nncf.compress_weights
   nncf.quantize
   nncf.quantize_with_accuracy_control



.. py:function:: strip(model, do_copy = True)

   Returns the model object with as much custom NNCF additions as possible removed
   while still preserving the functioning of the model object as a compressed model.

   :param model: The compressed model.
   :param do_copy: If True (default), will return a copy of the currently associated model object. If False,
     will return the currently associated model object "stripped" in-place.
   :return: The stripped model.


.. py:class:: NNCFConfig(*args, **kwargs)

   Bases: :py:obj:`dict`

   Contains the configuration parameters required for NNCF to apply the selected algorithms.

   This is a regular dictionary object extended with some utility functions, such as the ability to attach well-defined
   structures to pass non-serializable objects as parameters. It is primarily built from a .json file, or from a
   Python JSON-like dictionary - both data types will be checked against a JSONSchema. See the definition of the
   schema at https://openvinotoolkit.github.io/nncf/schema/, or by calling NNCFConfig.schema().

   .. py:method:: from_dict(nncf_dict)
      :classmethod:

      Load NNCF config from a Python dictionary. The dict must contain only JSON-supported primitives.

      :param nncf_dict: A Python dict with the JSON-style configuration for NNCF.


   .. py:method:: from_json(path)
      :classmethod:

      Load NNCF config from a JSON file at `path`.

      :param path: Path to the .json file containing the NNCF configuration.


   .. py:method:: register_extra_structs(struct_list)

      Attach the supplied list of extra configuration structures to this configuration object.

      :param struct_list: List of extra configuration structures.


   .. py:method:: get_redefinable_global_param_value_for_algo(param_name, algo_name)

      Some parameters can be specified both on the global NNCF config .json level (so that they apply
      to all algos), and at the same time overridden in the algorithm-specific section of the .json.
      This function returns the value that should apply for a given algorithm name, considering the
      exact format of this config.

      :param param_name: The name of a parameter in the .json specification of the NNCFConfig, that may
        be present either at the top-most level of the .json, or at the top level of the algorithm-specific
        subdict.
      :param algo_name: The name of the algorithm (among the allowed algorithm names in the .json) for which
        the resolution of the redefinable parameter should occur.
      :return: The value of the parameter that should be applied for the algo specified by `algo_name`.


   .. py:method:: schema()
      :staticmethod:

      Returns the JSONSchema against which the input data formats (.json or Python dict) are validated.



.. py:class:: Dataset(data_source, transform_func = None)

   Bases: :py:obj:`Generic`\ [\ :py:obj:`DataItem`\ , :py:obj:`ModelInput`\ ]

   Wrapper for passing custom user datasets into NNCF algorithms.

   This class defines the interface by which compression algorithms
   retrieve data items from the passed data source object. These data items are used
   for different purposes, for example, model inference and model validation, based
   on the choice of the exact compression algorithm.

   If the data item has been returned from the data source per iteration and it cannot be
   used as input for model inference, the transformation function is used to extract the
   model's input from this data item. For example, in supervised learning, the data item
   usually contains both examples and labels. So transformation function should extract
   the examples from the data item.

   :param data_source: The iterable object serving as the source of data items.
   :param transform_func: The function that is used to extract the model's input
       from the data item. The data item here is the data item that is returned from
       the data source per iteration. This function should be passed when
       the data item cannot be directly used as model's input. If this is not specified, then the data item
       will be passed into the model as-is.

   .. py:method:: get_data(indices = None)

      Returns the iterable object that contains selected data items from the data source as-is.

      :param indices: The zero-based indices of data items that should be selected from
          the data source. The indices should be sorted in ascending order. If indices are
          not passed all data items are selected from the data source.
      :return: The iterable object that contains selected data items from the data source as-is.


   .. py:method:: get_inference_data(indices = None)

      Returns the iterable object that contains selected data items from the data source, for which
      the transformation function was applied. The item, which was returned per iteration from this
      iterable, can be used as the model's input for model inference.

      :param indices: The zero-based indices of data items that should be selected from
          the data source. The indices should be sorted in ascending order. If indices are
          not passed all data items are selected from the data source.
      :return: The iterable object that contains selected data items from the data source, for which
          the transformation function was applied.


   .. py:method:: get_length()

      Tries to fetch length of the underlying dataset.
      :return: The length of the data_source if __len__() is implemented for it, and None otherwise.



.. py:class:: CompressWeightsMode

   Bases: :py:obj:`enum.Enum`

   Defines a mode for weight compression.
   :param INT8_SYM: Stands for 8-bit integer symmetric quantization of all weights.
       Weights are quantized symmetrically with a fixed zero point equals to 128.
       https://github.com/openvinotoolkit/nncf/blob/develop/docs/compression_algorithms/Quantization.md#symmetric-quantization
   :param INT8_ASYM: The same as INT8_SYM mode, but weights are quantized to a primary precision asymmetrically
       with a typical non-fixed zero point.
       https://github.com/openvinotoolkit/nncf/blob/develop/docs/compression_algorithms/Quantization.md#asymmetric-quantization
   :param INT4_SYM: Stands for a mixed-precision weights quantization with 4-bit integer as a primary precision.
       Weights are quantized to a primary precision symmetrically with a fixed zero point equals to 8.
       All embeddings and the last layer are always compressed to a backup precision, which is INT8_ASYM,
       by default. All others are quantized whether to 4-bit integer or to a backup precision depending on
       criteria and the given ratio.
       https://github.com/openvinotoolkit/nncf/blob/develop/docs/compression_algorithms/Quantization.md#symmetric-quantization
   :param INT4_ASYM: The same as INT4_SYM mode, but weights are quantized to a primary precision asymmetrically
       with a typical non-fixed zero point.
       https://github.com/openvinotoolkit/nncf/blob/develop/docs/compression_algorithms/Quantization.md#asymmetric-quantization
   :param NF4: The the same as INT4_SYM mode, but primary precision is NF4 data type without zero point.
   :param INT8: Mode is deprecated and will be removed in future releases. Please use `INT8_ASYM` instead.


.. py:class:: DropType

   Bases: :py:obj:`enum.Enum`

   Describes the accuracy drop type, which determines how the accuracy drop between
   the original model and the compressed model is calculated.

   :param ABSOLUTE: The accuracy drop is calculated as the absolute drop with respect
       to the results of the original model.
   :param RELATIVE: The accuracy drop is calculated relative to the results of
       the original model.


.. py:class:: ModelType

   Bases: :py:obj:`enum.Enum`

   Describes the model type the specificity of which will be taken into account during compression.

   :param TRANSFORMER: Transformer-based models
       (https://arxiv.org/pdf/1706.03762.pdf)


.. py:class:: QuantizationMode

   Bases: :py:obj:`enum.Enum`

   Defines special modes.
   Currently contains only FP8-related modes (https://arxiv.org/pdf/2209.05433.pdf).

   :param FP8_E4M3: Mode with 4-bit exponent and 3-bit mantissa.
   :param FP8_E5M2: Mode with 5-bit exponent and 2-bit mantissa.


.. py:class:: TargetDevice

   Bases: :py:obj:`enum.Enum`

   Target device architecture for compression.

   Compression will take into account the value of this parameter in order to obtain the best performance
   for this type of device.


.. py:class:: QuantizationPreset

   Bases: :py:obj:`enum.Enum`

   An enum with values corresponding to the available quantization presets.


.. py:function:: compress_weights(model, mode=CompressWeightsMode.INT8_ASYM, ratio = None, group_size = None, ignored_scope = None, all_layers = None)

   Compress model weights.

   :param model: A model to be compressed.
   :param mode: Defines a mode for weight compression.
       INT8_SYM stands for 8-bit integer symmetric quantization of all weights.
       INT8_ASYM is the same as INT8_SYM mode, but weights are quantized to a primary precision asymmetrically
           with a typical non-fixed zero point.
       INT4_SYM stands for a mixed-precision weights quantization with 4-bit integer as a primary precision.
           Weights are quantized to a primary precision symmetrically with a fixed zero point equals to 8.
           All embeddings and the last layer are always compressed to a backup precision, which is INT8_ASYM,
           by default. All others are quantized whether to 4-bit integer or to a backup precision depending on
           criteria and the given ratio.
       INT4_ASYM is the same as INT4_SYM mode, but weights are quantized to a primary precision asymmetrically
           with a typical non-fixed zero point.
       NF4 is the same as INT4_SYM mode, but primary precision is NF4 data type without zero point.
   :param ratio: the ratio between baseline and backup precisions (e.g. 0.9 means 90% of layers quantized to NF4
       and the rest to INT8_ASYM).
   :param group_size: number of weights (e.g. 128) in the channel dimension that share quantization parameters (scale).
       The value -1 means no grouping.
   :param ignored_scope: An ignored scope that defined the list of model control
       flow graph nodes to be ignored during quantization.
   :param all_layers: Indicates whether embeddings and last layers should be compressed to a primary
       precision. By default, the backup precision is assigned for the embeddings and last layers.
   :return: The non-trainable model with compressed weights.


.. py:function:: quantize(model, calibration_dataset, mode = None, preset = None, target_device = TargetDevice.ANY, subset_size = 300, fast_bias_correction = True, model_type = None, ignored_scope = None, advanced_parameters = None)

   Applies post-training quantization to the provided model.

   :param model: A model to be quantized.
   :type  model: TModel
   :param calibration_dataset: A representative dataset for the
       calibration process.
   :type  calibration_dataset: nncf.Dataset
   :param mode: Special quantization mode that specify different ways of the optimization.
   :type mode: Optional[nncf.QuantizationMode]
   :param preset: A preset controls the quantization mode (symmetric and asymmetric).
       It can take the following values:
       - `performance`: Symmetric quantization of weights and activations.
       - `mixed`: Symmetric quantization of weights and asymmetric quantization of activations.
       Default value is None. In this case, `mixed` preset is used for `transformer`
       model type otherwise `performance`.
   :type  preset: nncf.QuantizationPreset
   :param target_device: A target device the specificity of which will be taken
       into account while compressing in order to obtain the best performance
       for this type of device.
   :type  target_device: nncf.TargetDevice
   :param subset_size: Size of a subset to calculate activations statistics used for quantization.
       Must be positive.
   :param fast_bias_correction: Setting this option to `False` enables a different
       bias correction method which is more accurate, in general, and takes
       more time but requires less memory.
   :param model_type: Model type is needed to specify additional patterns
       in the model. Supported only `transformer` now.
   :type  model_type: Optional[nncf.ModelType]
   :param ignored_scope: An ignored scope that defined the list of model control
       flow graph nodes to be ignored during quantization.
   :type  ignored_scope: Optional[nncf.IgnoredScope]
   :param advanced_parameters: Advanced quantization parameters for
       fine-tuning the quantization algorithm.
   :return: The quantized model.
   :rtype: TModel


.. py:function:: quantize_with_accuracy_control(model, calibration_dataset, validation_dataset, validation_fn, max_drop = 0.01, drop_type = DropType.ABSOLUTE, preset = None, target_device = TargetDevice.ANY, subset_size = 300, fast_bias_correction = True, model_type = None, ignored_scope = None, advanced_quantization_parameters = None, advanced_accuracy_restorer_parameters = None)

   Applies post-training quantization algorithm with accuracy control to provided model.

   :param model: A model to be quantized.
   :type model: TModel
   :param calibration_dataset: A representative dataset for the calibration process.
   :type calibration_dataset: nncf.Dataset
   :param validation_dataset: A dataset for the validation process.
   :type validation_dataset: nncf.Dataset
   :param validation_fn: A validation function to validate the model. It should take two arguments:
       - `model`: model to be validate.
       - `validation_dataset`: dataset that provides data items to
             validate the provided model.
       The function should return the value of the metric with the following meaning:
       A higher value corresponds to better performance of the model.
   :param max_drop: The maximum accuracy drop that should be achieved after the quantization.
   :param drop_type: The accuracy drop type, which determines how the maximum accuracy
       drop between the original model and the compressed model is calculated.
   :param preset: A preset controls the quantization mode (symmetric and asymmetric).
       It can take the following values:
       - `performance`: Symmetric quantization of weights and activations.
       - `mixed`: Symmetric quantization of weights and asymmetric quantization of activations.
       Default value is None. In this case, `mixed` preset is used for `transformer`
       model type otherwise `performance`.
   :type preset: nncf.QuantizationPreset
   :param target_device: A target device the specificity of which will be taken
       into account while compressing in order to obtain the best performance
       for this type of device.
   :type target_device: nncf.TargetDevice
   :param subset_size: Size of a subset to calculate activations
       statistics used for quantization.
   :param fast_bias_correction: Setting this option to `False` enables a different
       bias correction method which is more accurate, in general, and takes
       more time but requires less memory.
   :param model_type: Model type is needed to specify additional patterns
       in the model. Supported only `transformer` now.
   :type model_type: nncf.ModelType
   :param ignored_scope: An ignored scope that defined the list of model control
       flow graph nodes to be ignored during quantization.
   :type ignored_scope: nncf.IgnoredScope
   :param advanced_quantization_parameters: Advanced quantization parameters for
       fine-tuning the quantization algorithm.
   :param advanced_accuracy_restorer_parameters: Advanced parameters for fine-tuning
       the accuracy restorer algorithm.
   :type advanced_accuracy_restorer_parameters: Optional[AdvancedAccuracyRestorerParameters]
   :return: The quantized model.
   :rtype: TModel


.. py:class:: IgnoredScope

   Provides an option to specify portions of model to be excluded from compression.

   The ignored scope defines model sub-graphs that should be excluded from the compression process such as
   quantization, pruning and etc.

   Example:

   ..  code-block:: python

           import nncf

           # Exclude by node name:
           node_names = ['node_1', 'node_2', 'node_3']
           ignored_scope = nncf.IgnoredScope(names=node_names)

           # Exclude using regular expressions:
           patterns = ['node_\d']
           ignored_scope = nncf.IgnoredScope(patterns=patterns)

           # Exclude by operation type:

           # OpenVINO opset https://docs.openvino.ai/latest/openvino_docs_ops_opset.html
           operation_types = ['Multiply', 'GroupConvolution', 'Interpolate']
           ignored_scope = nncf.IgnoredScope(types=operation_types)

           # ONNX opset https://github.com/onnx/onnx/blob/main/docs/Operators.md
           operation_types = ['Mul', 'Conv', 'Resize']
           ignored_scope = nncf.IgnoredScope(types=operation_types)

   **Note:** Operation types must be specified according to the model framework.

   :param names: List of ignored node names.
   :type names: List[str]
   :param patterns: List of regular expressions that define patterns for names of ignored nodes.
   :type patterns: List[str]
   :param types: List of ignored operation types.
   :type types: List[str]
   :param validate: If set to True, then a RuntimeError will be raised if any ignored scope does not match
     in the model graph.
   :type types: bool


